<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>ChatBot ile Harita Arama</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 400px; margin-top: 20px; }
    #chatMessages { height: 150px; overflow-y: auto; background: #f3f3f3; padding: 10px; }
    #chatInput { width: 100%; padding: 10px; }
  </style>
</head>
<body>
  <h2>ChatBot ile Harita Arama</h2>
  <div id="chatMessages"></div>
  <input id="chatInput" type="text" placeholder="Mesajınızı yazın..."/>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([39.9208, 32.8541], 6); // default: Turkey
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    const chatInput = document.getElementById("chatInput");
    const chatMessages = document.getElementById("chatMessages");

    chatInput.addEventListener("keypress", async function (e) {
      if (e.key === "Enter") {
        const input = chatInput.value.trim().toLowerCase();
        if (!input) return;

        // Show user message
        const userMsg = document.createElement("div");
        userMsg.textContent = input;
        userMsg.className = "text-right text-blue-700 mb-2";
        chatMessages.appendChild(userMsg);

        // Bot starts working
        let botResponse = "Anlayamadım. Lütfen örnek olarak 'ankara kızılaydaki restoranlar' şeklinde yazın.";
        const placeMatch = input.match(/(.*?)(?:'da|de|daki|deki)?\s*(market|kafe|restoran|eczane|kitapçı)/i);

        if (placeMatch) {
          const location = placeMatch[1].trim();
          const placeType = placeMatch[2].trim();

          botResponse = `Şehir "${location}" ve işletme türü "${placeType}" olarak ayarlandı. Yerler getiriliyor...`;

          const locData = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
            .then(res => res.json());

          if (locData.length > 0) {
            const { lat, lon } = locData[0];
            map.setView([lat, lon], 15);

            const overpassQuery = `
              [out:json];
              node["amenity"="${placeType}"](around:1000,${lat},${lon});
              out;
            `;

            const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`;
            const results = await fetch(overpassUrl).then(res => res.json());

            if (results.elements.length > 0) {
              results.elements.forEach(place => {
                const marker = L.marker([place.lat, place.lon]).addTo(map);
                marker.bindPopup(place.tags.name || placeType);
              });
              botResponse += ` ${results.elements.length} sonuç bulundu.`;
            } else {
              botResponse += " Hiçbir sonuç bulunamadı.";
            }
          } else {
            botResponse = "Konum bulunamadı.";
          }
        }

        const botMsg = document.createElement("div");
        botMsg.textContent = botResponse;
        botMsg.className = "text-gray-700 mb-2";
        chatMessages.appendChild(botMsg);

        chatInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    });
  </script>
</body>
</html>
